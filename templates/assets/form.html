{% extends "base.html" %}

{% block title %}{% if asset %}Edit Asset{% else %}New Asset{% endif %} - IFT Ignite Portal{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex items-center mb-6">
            <a href="{% if asset %}{{ url_for('assets_detail', asset_id=asset.id) }}{% else %}{{ url_for('assets_index') }}{% endif %}" class="mr-4 text-blue-600 hover:text-blue-800">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <h1 class="text-2xl font-bold text-gray-900">
                {% if asset %}Edit Asset{% else %}New Asset{% endif %}
            </h1>
        </div>

        <!-- Form -->
        <div class="bg-white shadow rounded-lg p-6">
            <form method="POST" action="{% if asset %}{{ url_for('assets_update', asset_id=asset.id) }}{% else %}{{ url_for('assets_create') }}{% endif %}">
                <div class="space-y-6">
                    <!-- Vehicle Information -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Vehicle Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="Year" class="block text-sm font-medium text-gray-700 mb-1">
                                    Year *
                                </label>
                                <input type="number" id="Year" name="Year" required min="1900" max="2025"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.Year if asset else '' }}" placeholder="2024">
                            </div>
                            <div>
                                <label for="Make" class="block text-sm font-medium text-gray-700 mb-1">
                                    Make *
                                </label>
                                <input type="text" id="Make" name="Make" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.Make if asset else '' }}" placeholder="Toyota">
                            </div>
                            <div>
                                <label for="Model" class="block text-sm font-medium text-gray-700 mb-1">
                                    Model *
                                </label>
                                <input type="text" id="Model" name="Model" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.Model if asset else '' }}" placeholder="Camry">
                            </div>
                            <div>
                                <label for="VIN" class="block text-sm font-medium text-gray-700 mb-1">
                                    VIN *
                                </label>
                                <input type="text" id="VIN" name="VIN" required maxlength="17"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"
                                       value="{{ asset.VIN or asset.Vin if asset else '' }}" placeholder="1HGBH41JXMN109186" style="text-transform: uppercase;">
                            </div>
                            <div>
                                <label for="mileage" class="block text-sm font-medium text-gray-700 mb-1">
                                    Mileage
                                </label>
                                <input type="number" id="mileage" name="mileage" min="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.mileage if asset else '' }}" placeholder="50000">
                            </div>
                            <div>
                                <label for="color" class="block text-sm font-medium text-gray-700 mb-1">
                                    Color
                                </label>
                                <input type="text" id="color" name="color"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.color if asset else '' }}" placeholder="Blue">
                            </div>
                        </div>
                    </div>

                    <!-- Financial Information -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Financial Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="value" class="block text-sm font-medium text-gray-700 mb-1">
                                    Current Value
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">$</span>
                                    </div>
                                    <input type="number" step="0.01" id="value" name="value" min="0"
                                           class="w-full pl-7 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           value="{{ asset.value or asset.Valuation if asset else '' }}" placeholder="25000.00">
                                </div>
                            </div>
                            <div>
                                <label for="purchase_price" class="block text-sm font-medium text-gray-700 mb-1">
                                    Purchase Price
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">$</span>
                                    </div>
                                    <input type="number" step="0.01" id="purchase_price" name="purchase_price" min="0"
                                           class="w-full pl-7 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           value="{{ asset.purchase_price if asset else '' }}" placeholder="30000.00">
                                </div>
                            </div>
                            <div>
                                <label for="loan_balance" class="block text-sm font-medium text-gray-700 mb-1">
                                    Loan Balance
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 sm:text-sm">$</span>
                                    </div>
                                    <input type="number" step="0.01" id="loan_balance" name="loan_balance" min="0"
                                           class="w-full pl-7 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           value="{{ asset.loan_balance if asset else '' }}" placeholder="15000.00">
                                </div>
                            </div>
                        </div>

                        <!-- Equity Display -->
                        <div class="mt-4">
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">Calculated Equity:</span>
                                    <span id="equityDisplay" class="text-lg font-bold text-gray-900">$0.00</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Current Value - Loan Balance</p>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Additional Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="condition" class="block text-sm font-medium text-gray-700 mb-1">
                                    Condition
                                </label>
                                <select id="condition" name="condition"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Condition</option>
                                    <option value="Excellent" {% if asset and asset.condition == 'Excellent' %}selected{% endif %}>Excellent</option>
                                    <option value="Good" {% if asset and asset.condition == 'Good' %}selected{% endif %}>Good</option>
                                    <option value="Fair" {% if asset and asset.condition == 'Fair' %}selected{% endif %}>Fair</option>
                                    <option value="Poor" {% if asset and asset.condition == 'Poor' %}selected{% endif %}>Poor</option>
                                </select>
                            </div>
                            <div>
                                <label for="location" class="block text-sm font-medium text-gray-700 mb-1">
                                    Location
                                </label>
                                <input type="text" id="location" name="location"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.location if asset else '' }}" placeholder="Dealer lot, Customer, etc.">
                            </div>
                            <div>
                                <label for="license_plate" class="block text-sm font-medium text-gray-700 mb-1">
                                    License Plate
                                </label>
                                <input type="text" id="license_plate" name="license_plate"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.license_plate or asset.LicensePlate if asset else '' }}" placeholder="ABC-123">
                            </div>
                            <div>
                                <label for="insurance_company" class="block text-sm font-medium text-gray-700 mb-1">
                                    Insurance Company
                                </label>
                                <input type="text" id="insurance_company" name="insurance_company"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.insurance_company if asset else '' }}" placeholder="State Farm">
                            </div>
                        </div>
                    </div>

                    <!-- Status and Relationships -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Status & Relationships</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="status" class="block text-sm font-medium text-gray-700 mb-1">
                                    Status
                                </label>
                                <select id="status" name="status"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="Active" {% if asset and asset.status == 'Active' %}selected{% elif not asset %}selected{% endif %}>Active</option>
                                    <option value="Inactive" {% if asset and asset.status == 'Inactive' %}selected{% endif %}>Inactive</option>
                                    <option value="Sold" {% if asset and asset.status == 'Sold' %}selected{% endif %}>Sold</option>
                                    <option value="Totaled" {% if asset and asset.status == 'Totaled' %}selected{% endif %}>Totaled</option>
                                    <option value="Repossessed" {% if asset and asset.status == 'Repossessed' %}selected{% endif %}>Repossessed</option>
                                </select>
                            </div>
                            <div>
                                <label for="account_id" class="block text-sm font-medium text-gray-700 mb-1">Account</label>
                                <select name="account_id" id="account_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Account</option>
                                    {% for account in accounts %}
                                    <option value="{{ account.id }}" {% if asset and asset.account_id == account.id %}selected{% endif %}>
                                        {{ account.account_name or account.company_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Important Dates -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Important Dates</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="purchase_date" class="block text-sm font-medium text-gray-700 mb-1">
                                    Purchase Date
                                </label>
                                <input type="date" id="purchase_date" name="purchase_date"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.purchase_date if asset else '' }}">
                            </div>
                            <div>
                                <label for="registration_date" class="block text-sm font-medium text-gray-700 mb-1">
                                    Registration Date
                                </label>
                                <input type="date" id="registration_date" name="registration_date"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.registration_date if asset else '' }}">
                            </div>
                            <div>
                                <label for="insurance_expiry" class="block text-sm font-medium text-gray-700 mb-1">
                                    Insurance Expiry
                                </label>
                                <input type="date" id="insurance_expiry" name="insurance_expiry"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="{{ asset.insurance_expiry if asset else '' }}">
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Notes</h3>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
                                Additional Notes
                            </label>
                            <textarea id="notes" name="notes" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      placeholder="Any additional information about this asset...">{{ asset.notes if asset else '' }}</textarea>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
                        <a href="{% if asset %}{{ url_for('assets_detail', asset_id=asset.id) }}{% else %}{{ url_for('assets_index') }}{% endif %}" 
                           class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            {% if asset %}Update Asset{% else %}Create Asset{% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Asset form functionality
document.addEventListener('DOMContentLoaded', function() {
    // Auto-uppercase VIN input
    const vinInput = document.getElementById('VIN');
    if (vinInput) {
        vinInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }

    // Auto-calculate equity when values change
    const valueInput = document.querySelector('input[name="value"]');
    const loanBalanceInput = document.querySelector('input[name="loan_balance"]');
    const equityDisplay = document.getElementById('equityDisplay');
    
    function calculateEquity() {
        const value = parseFloat(valueInput.value) || 0;
        const loanBalance = parseFloat(loanBalanceInput.value) || 0;
        const equity = value - loanBalance;
        
        if (equityDisplay) {
            equityDisplay.textContent = formatCurrency(equity);
            
            // Color coding
            if (equity > 0) {
                equityDisplay.className = 'text-lg font-bold text-green-600';
            } else if (equity < 0) {
                equityDisplay.className = 'text-lg font-bold text-red-600';
            } else {
                equityDisplay.className = 'text-lg font-bold text-gray-900';
            }
        }
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(amount);
    }

    if (valueInput && loanBalanceInput && equityDisplay) {
        valueInput.addEventListener('input', calculateEquity);
        loanBalanceInput.addEventListener('input', calculateEquity);
        
        // Calculate on page load
        calculateEquity();
    }

    // Form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Validate required fields
            const requiredFields = ['Year', 'Make', 'Model', 'VIN'];
            let isValid = true;

            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (field && !field.value.trim()) {
                    alert(`${fieldName} is required`);
                    field.focus();
                    isValid = false;
                    e.preventDefault();
                    return false;
                }
            });

            // Validate year
            const yearField = document.getElementById('Year');
            if (yearField && yearField.value) {
                const year = parseInt(yearField.value);
                const currentYear = new Date().getFullYear();
                if (year < 1900 || year > currentYear + 1) {
                    alert(`Year must be between 1900 and ${currentYear + 1}`);
                    yearField.focus();
                    isValid = false;
                    e.preventDefault();
                }
            }

            // Validate VIN length
            const vinField = document.getElementById('VIN');
            if (vinField && vinField.value && vinField.value.length !== 17) {
                alert('VIN must be exactly 17 characters');
                vinField.focus();
                isValid = false;
                e.preventDefault();
            }

            return isValid;
        });
    }

    // Auto-format number inputs
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (this.value && this.step === '0.01') {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });
    });

    // Add visual feedback for required fields
    const requiredInputs = document.querySelectorAll('input[required]');
    requiredInputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.classList.add('border-red-300');
            } else {
                this.classList.remove('border-red-300');
                this.classList.add('border-green-300');
                setTimeout(() => {
                    this.classList.remove('border-green-300');
                }, 1000);
            }
        });
    });
});
</script>

<script src="{{ url_for('static', filename='js/assets.js') }}"></script>
{% endblock %}