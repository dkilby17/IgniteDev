<!-- templates/auth/mfa_backup_codes.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save Your Backup Codes - Ignite Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .backup-codes-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        .backup-code {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            font-weight: bold;
            letter-spacing: 0.1em;
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .copy-btn {
            font-size: 0.8em;
            padding: 2px 8px;
        }
        @media print {
            body {
                background: white;
            }
            .no-print {
                display: none;
            }
            .backup-codes-card {
                box-shadow: none;
                border: 1px solid #dee2e6;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="backup-codes-card p-5">
                    <!-- Header -->
                    <div class="text-center mb-4">
                        <i class="fas fa-shield-check text-success" style="font-size: 3rem;"></i>
                        <h2 class="mt-3 mb-2 text-success">MFA Setup Complete!</h2>
                        <p class="lead text-muted">
                            Save these backup codes in a secure location
                        </p>
                    </div>

                    <!-- Flash Messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'warning' if category == 'warning' else 'info' }} alert-dismissible fade show no-print" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <!-- Important Notice -->
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>Important: Save These Backup Codes
                        </h6>
                        <p class="mb-0">
                            These codes can be used to access your account if you lose your authenticator device. 
                            <strong>Each code can only be used once.</strong> Store them in a safe place.
                        </p>
                    </div>

                    <!-- Backup Codes -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-key me-2"></i>Your Backup Codes
                            </h6>
                            <div class="no-print">
                                <button class="btn btn-outline-primary btn-sm me-2" id="copyAllBtn">
                                    <i class="fas fa-copy me-1"></i>Copy All
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                                    <i class="fas fa-print me-1"></i>Print
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if backup_codes %}
                                <div class="row" id="codesContainer">
                                    {% for code in backup_codes %}
                                    <div class="col-md-6">
                                        <div class="backup-code">
                                            <span class="code-text">{{ code }}</span>
                                            <button class="btn btn-outline-secondary copy-btn no-print" data-code="{{ code }}">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- Hidden textarea for copying all codes -->
                                <textarea id="allCodesText" style="display: none;">{% for code in backup_codes %}{{ code }}{% if not loop.last %}
{% endif %}{% endfor %}</textarea>
                                
                            {% else %}
                                <div class="text-center text-muted">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    No backup codes were generated. Please contact support.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>How to Use Backup Codes
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                <li class="mb-2">
                                    <strong>When to use:</strong> If you lose access to your authenticator app or device
                                </li>
                                <li class="mb-2">
                                    <strong>How to use:</strong> Enter any unused backup code instead of your authenticator code
                                </li>
                                <li class="mb-2">
                                    <strong>Important:</strong> Each code works only once - mark it as used after entering it
                                </li>
                                <li class="mb-0">
                                    <strong>Storage:</strong> Keep these codes in a password manager or secure location
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div class="d-grid mt-4 no-print">
                        <a href="{{ url_for('auth.mfa_backup_codes_done') }}" class="btn btn-success btn-lg" id="continueButton">
                            <i class="fas fa-check me-2"></i>
                            I've Saved My Backup Codes - Continue to Portal
                        </a>
                    </div>

                    <!-- Security Notice -->
                    <div class="text-center mt-4">
                        <p class="small text-muted">
                            <i class="fas fa-lock me-1"></i>
                            Your account is now protected with two-factor authentication.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var hasClickedContinue = false;
            
            // Handle individual code copying
            var copyButtons = document.querySelectorAll('.copy-btn');
            copyButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    var code = this.getAttribute('data-code');
                    copyToClipboard(code, this);
                });
            });
            
            // Handle copy all codes
            var copyAllBtn = document.getElementById('copyAllBtn');
            if (copyAllBtn) {
                copyAllBtn.addEventListener('click', function() {
                    var allCodesTextarea = document.getElementById('allCodesText');
                    if (allCodesTextarea) {
                        copyToClipboard(allCodesTextarea.value, this);
                    }
                });
            }
            
            // Handle continue button
            var continueButton = document.getElementById('continueButton');
            if (continueButton) {
                continueButton.addEventListener('click', function() {
                    hasClickedContinue = true;
                });
            }
            
            // Warning before leaving page
            window.addEventListener('beforeunload', function(e) {
                if (!hasClickedContinue) {
                    var confirmationMessage = 'Have you saved your backup codes? You won\'t be able to see them again.';
                    e.returnValue = confirmationMessage;
                    return confirmationMessage;
                }
            });
            
            // Auto-focus on first copy button
            var firstCopyBtn = document.querySelector('.copy-btn');
            if (firstCopyBtn) {
                firstCopyBtn.focus();
            }
        });
        
        function copyToClipboard(text, button) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() {
                    showCopySuccess(button);
                }).catch(function(err) {
                    console.error('Clipboard API failed: ', err);
                    fallbackCopy(text, button);
                });
            } else {
                fallbackCopy(text, button);
            }
        }
        
        function fallbackCopy(text, button) {
            var textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess(button);
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                alert('Copy failed. Please manually select and copy the codes.');
            }
            
            document.body.removeChild(textArea);
        }
        
        function showCopySuccess(button) {
            var originalHTML = button.innerHTML;
            var originalClasses = button.className;
            
            if (button.id === 'copyAllBtn') {
                button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                button.className = 'btn btn-success btn-sm me-2';
            } else {
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.className = 'btn btn-success copy-btn no-print';
            }
            
            setTimeout(function() {
                button.innerHTML = originalHTML;
                button.className = originalClasses;
            }, 2000);
        }
    </script>
</body>
</html>