{% extends "base.html" %}

{% block title %}Loan Details - IFT Ignite Portal{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" data-loan-id="{{ loan.get('id') }}">
    <div class="mb-6 flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center">
            <a href="{{ url_for('loans_index') }}" class="mr-4 p-2 rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-semibold text-gray-900">Contract #{{ loan.get('contract_number') or loan.get('contractnumber') or 'Unknown' }}</h1>
                <p class="mt-1 text-sm text-gray-600">{{ loan.get('loan_type') or 'Loan Details' }}</p>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <a href="{{ url_for('loans_edit', loan_id=loan.get('id')) }}" class="btn btn-primary">
                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Edit
            </a>
            <a href="{{ url_for('loans_new') }}" class="btn btn-secondary">
                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                New Loan
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="space-y-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-blue-900 mb-3">{{ (loan.get('loan_type') or 'Loan') | capitalize }} Information</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Contract #:</span>
                        <span class="font-medium text-gray-900">{{ loan.get('contract_number') or loan.get('contractnumber') or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Financial Institution:</span>
                        <span class="font-medium text-gray-900">{{ loan.get('financial_institution') or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Status:</span>
                        <span class="badge {% if (loan.get('loan_status') or '')|lower == 'active' %}badge-success{% elif (loan.get('loan_status') or '')|lower == 'default' %}badge-danger{% elif (loan.get('loan_status') or '')|lower == 'paid off' %}badge-secondary{% else %}badge-warning{% endif %}">
                            {{ loan.get('loan_status') | replace('_', ' ') | capitalize or 'Unknown' }}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Sub-Status:</span>
                        <span class="font-medium text-gray-900">{{ loan.get('loan_sub_status') or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Contract Start Date:</span>
                        <span class="text-gray-900">{{ loan.get('contract_start_date') | date if loan.get('contract_start_date') else 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Maturity Date:</span>
                        <span class="text-gray-900">{{ loan.get('maturity_date') | date if loan.get('maturity_date') else 'N/A' }}</span>
                    </div>
                </div>
            </div>

            {% set days_past_due = (loan.get('days_past_due')|int) if loan.get('days_past_due') else 0 %}
            {% set past_due_amount = loan.get('past_due_amount', 0) | float %}
            {% set past_due_fees = loan.get('past_due_fees', 0) | float %}
            {% set total_owing = past_due_amount + past_due_fees %}

            {% if days_past_due > 0 or total_owing > 0 %}
            <div class="delinquency-panel bg-red-50 border border-red-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-red-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 delinquency-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    Delinquency Information
                </h3>
                <div class="space-y-3 text-sm">
                    {% if days_past_due > 0 %}
                        <div class="flex justify-between">
                            <span class="text-red-700">Days Past Due:</span>
                            <span class="font-semibold text-red-900">{{ days_past_due }} days</span>
                        </div>
                    {% endif %}
                    
                    {% if past_due_amount > 0 %}
                        <div class="flex justify-between">
                            <span class="text-red-700">Past Due Amount:</span>
                            <span class="font-semibold text-red-900 currency">{{ past_due_amount | currency }}</span>
                        </div>
                    {% endif %}
                    
                    {% if past_due_fees > 0 %}
                        <div class="flex justify-between">
                            <span class="text-red-700">Past Due Fees:</span>
                            <span class="font-semibold text-red-900 currency">{{ past_due_fees | currency }}</span>
                        </div>
                    {% endif %}
                    
                    {% if total_owing > 0 %}
                        <div class="flex justify-between border-t border-red-200 pt-2 mt-2">
                            <span class="text-red-700">Total Amount Due:</span>
                            <span class="font-semibold text-red-900 currency-large">{{ total_owing | currency }}</span>
                        </div>
                    {% endif %}
                    
                    <!-- Only show NSF Reason if there's actual delinquency -->
                    {% if loan.get('NSF_Reason') and (days_past_due > 0 or total_owing > 0) %}
                        <div class="flex justify-between border-t border-red-200 pt-2 mt-2">
                            <span class="text-red-700">NSF Reason:</span>
                            <span class="font-semibold text-red-900">{{ loan.get('NSF_Reason') }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Financial Details</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Original Amount Financed:</span>
                        <span class="text-gray-900 currency">{{ loan.get('loan_amount') | currency }}</span>
                    </div>
                    <div class="flex justify-between font-semibold">
                        <span class="text-gray-600">Principal Balance:</span>
                        <span class="text-gray-900 currency">{{ loan.get('principal_balance') | currency }}</span>
                    </div>
                    {% if loan.get('residual_amount') %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Residual:</span>
                        <span class="text-gray-900 currency">{{ loan.get('residual_amount') | currency }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Interest Rate:</span>
                        <span class="text-gray-900">{{ "%.2f"|format(((loan.get('interest_rate', 0) or 0)|float) * 100) }}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Term:</span>
                        <span class="text-gray-900">{{ loan.get('term_months') or 'N/A' }} months</span>
                    </div>
                </div>
            </div>

            {% if (loan.get('loan_amount')|float(0)) > 0 %}
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Progress</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Amount Paid:</span>
                        <span class="font-medium text-gray-900 currency">{{ loan.get('amount_paid') | currency }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Remaining Balance:</span>
                        <span class="font-medium text-gray-900 currency">{{ loan.get('principal_balance') | currency }}</span>
                    </div>
                    <div class="mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full loan-progress-bar" data-progress="{{ loan.get('progress_percent', 0) }}" style="width: 0%;"></div>
                        </div>
                        <p class="text-right text-xs text-gray-500 mt-1">{{ loan.get('progress_percent', 0) }}% Paid</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Payment Information</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Monthly Payment:</span>
                        <span class="text-gray-900 currency">{{ loan.get('monthly_payment') | currency }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Payment Frequency:</span>
                        <span class="font-medium text-gray-900">{{ loan.get('payment_frequency') or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">First Payment Date:</span>
                        <span class="text-gray-900">{{ loan.get('first_payment_date') | date if loan.get('first_payment_date') else 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between font-semibold">
                        <span class="text-gray-600">Next Payment Date:</span>
                        <span class="text-gray-900">{{ loan.get('next_payment_date') | date if loan.get('next_payment_date') else 'N/A' }}</span>
                    </div>
                     <div class="flex justify-between border-t pt-3 mt-2">
                        <span class="text-gray-600">Previous Payment Date:</span>
                        <span class="text-gray-900">{{ loan.get('last_payment_date') | date if loan.get('last_payment_date') else 'N/A' }}</span>
                    </div>
                </div>
            </div>

            {% if loan.get('bank_account_number') or loan.get('bank_transit_number') or loan.get('bank_institution_number') %}
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Banking Information</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Account Number:</span>
                        <span class="font-medium text-gray-900">{{ loan.get('bank_account_number') or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Transit Number:</span>
                        <span class="font-medium text-gray-900">{{ loan.get('bank_transit_number') or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Institution Number:</span>
                        <span class="font-medium text-gray-900">{{ loan.get('bank_institution_number') or 'N/A' }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

             <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Dealer Information</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Dealer Name:</span>
                        <span class="font-medium text-gray-900">{{ loan.get('dealer_name') or 'N/A' }}</span>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Notes</h3>
                <div class="mt-1 text-sm text-gray-600 space-y-2" id="notesContainer">
                    {% if loan.get('notes') %}
                        <p class="whitespace-pre-wrap">{{ loan.get('notes') }}</p>
                    {% else %}
                        <p class="text-gray-500">No notes</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="space-y-6">
            {% if account %}
            <div class="bg-white border border-gray-200 rounded-lg">
                <div class="p-4 border-b">
                    <h3 class="text-lg font-medium text-gray-900">Related Account</h3>
                </div>
                <div class="p-4">
                    <a href="{{ url_for('accounts_detail', account_id=account.id) }}" class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900 hover:text-blue-600">{{ account.account_name or 'Unknown Account' }}</h4>
                                <div class="text-sm text-gray-600 space-y-1 mt-1">
                                    {% if account.account_number %}<p># {{ account.account_number }}</p>{% endif %}
                                    {% if account.primary_email %}<p>📧 {{ account.primary_email }}</p>{% endif %}
                                    {% if account.account_type %}<p>{{ account.account_type }}</p>{% endif %}
                                </div>
                            </div>
                            <span class="badge {% if (account.status or '')|lower == 'active' %}badge-success{% else %}badge-secondary{% endif %} ml-4">
                                {{ account.status or 'Unknown' }}
                            </span>
                        </div>
                    </a>
                </div>
            </div>
            {% endif %}

            {% if primary_contact or secondary_contact or contact %}
            <div class="bg-white border border-gray-200 rounded-lg">
                <div class="p-4 border-b"><h3 class="text-lg font-medium text-gray-900">Related Contacts</h3></div>
                <div class="p-4 space-y-3">
                    {% set p_contact = primary_contact or contact %}
                    {% if p_contact %}
                    <a href="{{ url_for('contacts_detail', contact_id=p_contact.id) }}" class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900 hover:text-blue-600">{{ p_contact.display_name or (p_contact.first_name ~ ' ' ~ p_contact.last_name) or 'Unknown Contact' }}</h4>
                                <div class="text-sm text-gray-600 space-y-1 mt-1">
                                    {% if p_contact.primary_email %}<p>📧 {{ p_contact.primary_email }}</p>{% endif %}
                                    {% if p_contact.home_phone %}<p>📞 {{ p_contact.home_phone }}</p>{% endif %}
                                    {% if p_contact.cell_phone %}<p>📱 {{ p_contact.cell_phone }}</p>{% endif %}
                                </div>
                            </div>
                            <span class="badge badge-primary">Primary</span>
                        </div>
                    </a>
                    {% endif %}
                    {% if secondary_contact %}
                    <a href="{{ url_for('contacts_detail', contact_id=secondary_contact.id) }}" class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                       <div class="flex justify-between items-start">
                           <div class="flex-1">
                                <h4 class="font-medium text-gray-900 hover:text-blue-600">{{ secondary_contact.display_name or (secondary_contact.first_name ~ ' ' ~ secondary_contact.last_name) or 'Unknown Contact' }}</h4>
                                <div class="text-sm text-gray-600 space-y-1 mt-1">
                                    {% if secondary_contact.primary_email %}<p>📧 {{ secondary_contact.primary_email }}</p>{% endif %}
                                    {% if secondary_contact.home_phone %}<p>📞 {{ secondary_contact.home_phone }}</p>{% endif %}
                                    {% if secondary_contact.cell_phone %}<p>📱 {{ secondary_contact.cell_phone }}</p>{% endif %}
                                </div>
                           </div>
                           <span class="badge badge-info">Co-Borrower</span>
                       </div>
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="bg-white border border-gray-200 rounded-lg">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Assets ({{ assets|length if assets else 0 }})</h3>
                    <a href="{{ url_for('assets_new') }}?loan_id={{ loan.get('id') }}&account_id={{ loan.get('account_id') }}" class="text-sm text-blue-600 hover:text-blue-800">Add Asset</a>
                </div>
                <div class="p-4">
                     {% if assets and assets|length > 0 %}
                        <div class="space-y-3">
                            {% for asset in assets %}
                            <a href="{{ url_for('assets_detail', asset_id=asset.id) }}" class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h4 class="font-medium text-gray-900 flex items-center mb-2 hover:text-blue-600">
                                            <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                            {{ asset.Year or '' }} {{ (asset.Make or '') ~ ' ' ~ (asset.Model or '') }}
                                        </h4>
                                        <div class="space-y-1 text-sm text-gray-600 pl-7">
                                            {% if asset.Vin %}<p>VIN: {{ asset.Vin }}</p>{% endif %}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        {% set raw_status = asset.get('InsuranceStatus', 'Unknown') %}
                                        {% set insurance_status = raw_status|string|trim|lower %}
                                        <span class="badge {% if insurance_status == 'active' %}badge-success{% elif insurance_status == 'expired' %}badge-danger{% else %}badge-secondary{% endif %}">
                                            {{ raw_status | capitalize }}
                                        </span>
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                     {% else %}
                        <div class="text-center text-gray-500 py-8">
                            <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18 10c-.1-.1-.4-.6-.9-1.2L15.8 7c-.1-.1-.8-.7-2.2-.8L4.9 6C4.3 6 4 6.4 4 7v4c0 .6.4 1 1 1h2m0 5h10m-10 0a2 2 0 1 0 0-4m10 4a2 2 0 1 0 0-4" />
                            </svg>
                            <p class="mt-2">No assets found</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Cases ({{ cases|length if cases else 0 }})</h3>
                    <a href="{{ url_for('cases_new') }}?loan_id={{ loan.get('id') }}&account_id={{ loan.get('account_id') }}" class="text-sm text-blue-600 hover:text-blue-800">Add Case</a>
                </div>
                <div class="p-4">
                    {% if cases and cases|length > 0 %}
                    <div class="space-y-3">
                            {% for case in cases %}
                            <a href="{{ url_for('cases_detail', case_id=case.id) }}" class="block border border-gray-200 rounded-lg p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-medium text-blue-600">Case #{{ case.get('case_number') or 'Unknown' }}</h4>
                                    <span class="badge {% if case.get('status') == 'Open' %}badge-warning{% elif case.get('status') == 'New' %}badge-info{% elif case.get('status') == 'Closed' %}badge-success{% else %}badge-secondary{% endif %}">{{ case.get('status', 'Unknown') }}</span>
                                </div>
                                <div class="mt-2 space-y-1 text-xs text-gray-600">
                                    <div class="flex justify-between">
                                        <span>Case Type:</span>
                                        <span class="font-medium text-gray-800">{{ case.get('case_type', 'N/A') }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Created Date:</span>
                                        <span class="font-medium text-gray-800">{{ case.get('created_at') | date }}</span>
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                    </div>
                    {% else %}
                        <div class="text-center text-gray-500 py-8">
                            <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="mt-2">No cases found</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="deleteModal" class="loans-modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77-.833.192 2.5 1.732 2.5z" /></svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-2">Delete Loan</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Are you sure you want to delete this loan? This action cannot be undone.
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="cancelDelete" class="px-4 py-2 bg-gray-300 text-gray-900 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 ml-2">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Add this to your existing detail.html template or create a separate debug page -->

<!-- Enhanced Debug Section - Replace the existing debug section -->
{% if config.DEBUG or request.args.get('debug') %}
<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
    <h3 class="text-lg font-medium text-yellow-800 mb-4">🔍 DETAILED DEBUG ANALYSIS</h3>
    
    <!-- Raw Data Overview -->
    <div class="mb-6">
        <h4 class="font-semibold text-yellow-700 mb-2">Raw Data Overview</h4>
        <div class="bg-white p-3 rounded border text-xs">
            <p><strong>Loan ID:</strong> {{ loan.get('id') if loan else 'No ID' }}</p>
            <p><strong>Total Fields:</strong> {{ loan.keys() | list | length if loan else 0 }}</p>
            <p><strong>All Fields:</strong> {{ loan.keys() | list | join(', ') if loan else 'No fields' }}</p>
        </div>
    </div>

    <!-- Field Analysis for N/A Values -->
    <div class="mb-6">
        <h4 class="font-semibold text-yellow-700 mb-2">🔍 Field Analysis (Why N/A?)</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            
            <!-- Sub-Status Analysis -->
            <div class="bg-white p-3 rounded border">
                <h5 class="font-medium text-gray-800 mb-2">Sub-Status Field</h5>
                <div class="text-xs space-y-1">
                    <p>loan_sub_status: {{ loan.get('loan_sub_status', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>sub_status: {{ loan.get('sub_status', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>substatus: {{ loan.get('substatus', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>status_detail: {{ loan.get('status_detail', 'MISSING') if loan else 'NO_LOAN' }}</p>
                </div>
            </div>

            <!-- Date Fields Analysis -->
            <div class="bg-white p-3 rounded border">
                <h5 class="font-medium text-gray-800 mb-2">Date Fields</h5>
                <div class="text-xs space-y-1">
                    <p>contract_start_date: {{ loan.get('contract_start_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>start_date: {{ loan.get('start_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>origination_date: {{ loan.get('origination_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>created_date: {{ loan.get('created_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                </div>
            </div>

            <!-- Maturity Date Analysis -->
            <div class="bg-white p-3 rounded border">
                <h5 class="font-medium text-gray-800 mb-2">Maturity Date Fields</h5>
                <div class="text-xs space-y-1">
                    <p>maturity_date: {{ loan.get('maturity_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>end_date: {{ loan.get('end_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>final_payment_date: {{ loan.get('final_payment_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>maturity: {{ loan.get('maturity', 'MISSING') if loan else 'NO_LOAN' }}</p>
                </div>
            </div>

            <!-- Payment Frequency Analysis -->
            <div class="bg-white p-3 rounded border">
                <h5 class="font-medium text-gray-800 mb-2">Payment Frequency Fields</h5>
                <div class="text-xs space-y-1">
                    <p>payment_frequency: {{ loan.get('payment_frequency', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>frequency: {{ loan.get('frequency', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>pay_frequency: {{ loan.get('pay_frequency', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>payment_schedule: {{ loan.get('payment_schedule', 'MISSING') if loan else 'NO_LOAN' }}</p>
                </div>
            </div>

            <!-- Payment Date Analysis -->
            <div class="bg-white p-3 rounded border">
                <h5 class="font-medium text-gray-800 mb-2">Payment Date Fields</h5>
                <div class="text-xs space-y-1">
                    <p>first_payment_date: {{ loan.get('first_payment_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>next_payment_date: {{ loan.get('next_payment_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>last_payment_date: {{ loan.get('last_payment_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>due_date: {{ loan.get('due_date', 'MISSING') if loan else 'NO_LOAN' }}</p>
                </div>
            </div>

            <!-- Dealer Information Analysis -->
            <div class="bg-white p-3 rounded border">
                <h5 class="font-medium text-gray-800 mb-2">Dealer Fields</h5>
                <div class="text-xs space-y-1">
                    <p>dealer_name: {{ loan.get('dealer_name', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>dealer: {{ loan.get('dealer', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>dealership: {{ loan.get('dealership', 'MISSING') if loan else 'NO_LOAN' }}</p>
                    <p>dealer_info: {{ loan.get('dealer_info', 'MISSING') if loan else 'NO_LOAN' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Field Search -->
    <div class="mb-6">
        <h4 class="font-semibold text-yellow-700 mb-2">🔍 Field Search (Look for patterns)</h4>
        <div class="bg-white p-3 rounded border text-xs">
            {% if loan %}
                {% set date_fields = [] %}
                {% set payment_fields = [] %}
                {% set status_fields = [] %}
                {% for key in loan.keys() %}
                    {% if 'date' in key|lower %}
                        {% set _ = date_fields.append(key) %}
                    {% endif %}
                    {% if 'payment' in key|lower %}
                        {% set _ = payment_fields.append(key) %}
                    {% endif %}
                    {% if 'status' in key|lower %}
                        {% set _ = status_fields.append(key) %}
                    {% endif %}
                {% endfor %}
                <p><strong>Date-related fields:</strong> {{ date_fields | join(', ') or 'None found' }}</p>
                <p><strong>Payment-related fields:</strong> {{ payment_fields | join(', ') or 'None found' }}</p>
                <p><strong>Status-related fields:</strong> {{ status_fields | join(', ') or 'None found' }}</p>
            {% else %}
                <p>No loan data to analyze</p>
            {% endif %}
        </div>
    </div>

    <!-- Action Items -->
    <div class="bg-red-50 border border-red-200 rounded p-3">
        <h4 class="font-semibold text-red-700 mb-2">🔧 Action Items</h4>
        <div class="text-xs text-red-600 space-y-1">
            <p>1. Check if the database actually contains these values</p>
            <p>2. Visit: <a href="/loans/{{ loan.get('id') }}/debug" class="underline">/loans/{{ loan.get('id') }}/debug</a> for raw JSON data</p>
            <p>3. Run SQL query: SELECT * FROM loans WHERE id = '{{ loan.get('id') }}'</p>
            <p>4. Check if field names in database match template expectations</p>
            <p>5. Verify if data was imported correctly from source system</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/loans.js') }}"></script>
{% endblock %}