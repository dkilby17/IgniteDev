{% extends "base.html" %}

{% block title %}Case #{{ case.case_number or case.id }} - IFT Ignite Portal{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6 flex justify-between items-center">
        <div class="flex items-center">
            <a href="{{ url_for('cases_index') }}" class="mr-4 p-2 rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-semibold text-gray-900">Case #{{ case.case_number or case.id }}</h1>
                <p class="mt-1 text-sm text-gray-600">{{ case.case_type or 'General Case' }}</p>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <a href="{{ url_for('cases_edit', case_id=case.id) }}" class="btn btn-primary">
                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Edit
            </a>
            <a href="{{ url_for('cases_new') }}" class="btn btn-secondary">
                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                New Case
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Side - Case Information -->
        <div class="space-y-6">
            <!-- Case Status & Info -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-blue-900 mb-3">Case Information</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Case Number:</span>
                        <span class="font-medium text-gray-900">{{ case.case_number or case.id or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Case Type:</span>
                        <span class="font-medium text-gray-900">{{ case.case_type or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Subject:</span>
                        <span class="font-medium text-gray-900">{{ case.subject or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Status:</span>
                        <span class="badge {% if case.status == 'Open' %}badge-warning{% elif case.status == 'New' %}badge-info{% elif case.status == 'Closed' %}badge-success{% elif case.status == 'In Progress' %}badge-info{% else %}badge-secondary{% endif %}">
                            {{ case.status or 'Unknown' }}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Priority:</span>
                        <span class="badge {% if case.priority == 'High' %}bg-red-100 text-red-800{% elif case.priority == 'Medium' %}bg-yellow-100 text-yellow-800{% else %}bg-green-100 text-green-800{% endif %}">
                            {{ case.priority or 'Low' }}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Created:</span>
                        <span class="text-gray-900">{{ case.created_at | date if case.created_at else 'N/A' }}</span>
                    </div>
                </div>
            </div>

            <!-- Description -->
            {% if case.description %}
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Description</h3>
                <div class="text-sm text-gray-900 whitespace-pre-wrap">{{ case.description }}</div>
            </div>
            {% endif %}

            <!-- Assignment Information -->
            {% if case.assigned_team or case.assigned_to_user_id %}
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Assignment Information</h3>
                <div class="space-y-3 text-sm">
                    {% if case.assigned_team %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Assigned Team:</span>
                        <span class="text-gray-900">{{ case.assigned_team }}</span>
                    </div>
                    {% endif %}
                    {% if case.assigned_to_user_id %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Assigned To:</span>
                        <span class="text-gray-900">User #{{ case.assigned_to_user_id }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Additional Dates -->
            {% if case.due_date or case.resolved_date or case.closed_date %}
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Important Dates</h3>
                <div class="space-y-3 text-sm">
                    {% if case.due_date %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Due Date:</span>
                        <span class="text-gray-900">{{ case.due_date | date }}</span>
                    </div>
                    {% endif %}
                    {% if case.resolved_date %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Resolved Date:</span>
                        <span class="text-gray-900">{{ case.resolved_date | date }}</span>
                    </div>
                    {% endif %}
                    {% if case.closed_date %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Closed Date:</span>
                        <span class="text-gray-900">{{ case.closed_date | date }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Financial Information -->
            {% if case.amount_involved or case.adjustment_amount or case.refund_amount %}
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Financial Information</h3>
                <div class="space-y-3 text-sm">
                    {% if case.amount_involved %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Amount Involved:</span>
                        <span class="text-gray-900 currency">{{ case.amount_involved | currency }}</span>
                    </div>
                    {% endif %}
                    {% if case.adjustment_amount %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Adjustment Amount:</span>
                        <span class="text-gray-900 currency">{{ case.adjustment_amount | currency }}</span>
                    </div>
                    {% endif %}
                    {% if case.refund_amount %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Refund Amount:</span>
                        <span class="text-gray-900 currency">{{ case.refund_amount | currency }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Resolution -->
            {% if case.resolution %}
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Resolution</h3>
                <div class="text-sm text-gray-900 whitespace-pre-wrap">{{ case.resolution }}</div>
                {% if case.resolution_type %}
                <div class="mt-3">
                    <span class="text-sm text-gray-600">Resolution Type:</span>
                    <span class="text-sm text-gray-900 ml-2">{{ case.resolution_type }}</span>
                </div>
                {% endif %}
                {% if case.customer_satisfaction %}
                <div class="mt-3">
                    <span class="text-sm text-gray-600">Customer Satisfaction:</span>
                    <span class="text-sm text-gray-900 ml-2">{{ case.customer_satisfaction }}/5</span>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Internal Notes -->
            {% if case.internal_notes %}
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Internal Notes</h3>
                <div class="text-sm text-gray-900 whitespace-pre-wrap">{{ case.internal_notes }}</div>
            </div>
            {% endif %}
        </div>

        <!-- Right Side - Related Data -->
        <div class="space-y-6">
            <!-- Quick Actions -->
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    <a href="{{ url_for('cases_edit', case_id=case.id) }}" class="block w-full btn btn-primary text-center">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Edit Case
                    </a>
                    
                    {% if case.status != 'Closed' %}
                    <button data-close-case="{{ case.id }}" 
                            class="block w-full btn btn-secondary text-center">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Close Case
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Related Account -->
            {% if account %}
            <div class="bg-white border border-gray-200 rounded-lg">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Related Account</h3>
                    <a href="{{ url_for('accounts_detail', account_id=account.id) }}" class="text-sm text-blue-600 hover:text-blue-800">View Account</a>
                </div>
                <div class="p-4">
                    <a href="{{ url_for('accounts_detail', account_id=account.id) }}" class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">{{ account.account_name or account.company_name or 'Unknown Account' }}</h4>
                                <div class="text-sm text-gray-600 space-y-1">
                                    {% if account.account_number %}
                                        <p>🔢 Account: {{ account.account_number }}</p>
                                    {% endif %}
                                    {% if account.account_type %}
                                        <p>📋 Type: {{ account.account_type }}</p>
                                    {% endif %}
                                    {% if account.primary_email %}
                                        <p>📧 {{ account.primary_email }}</p>
                                    {% endif %}
                                    {% if account.financial_institution %}
                                        <p>🏦 {{ account.financial_institution }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            <span class="badge {% if account.status == 'Active' %}badge-success{% else %}badge-secondary{% endif %}">
                                {{ account.status or 'Unknown' }}
                            </span>
                        </div>
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Related Contact -->
            {% if contact %}
            <div class="bg-white border border-gray-200 rounded-lg">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Related Contact</h3>
                    <a href="{{ url_for('contacts_detail', contact_id=contact.id) }}" class="text-sm text-blue-600 hover:text-blue-800">View Contact</a>
                </div>
                <div class="p-4">
                    <a href="{{ url_for('contacts_detail', contact_id=contact.id) }}" class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">
                                    {% if contact.display_name %}
                                        {{ contact.display_name }}
                                    {% elif contact.first_name or contact.last_name %}
                                        {{ (contact.first_name or '') ~ ' ' ~ (contact.last_name or '') }}
                                    {% else %}
                                        Unknown Contact
                                    {% endif %}
                                </h4>
                                <div class="text-sm text-gray-600 space-y-1">
                                    {% if contact.primary_email %}
                                        <p>📧 {{ contact.primary_email }}</p>
                                    {% endif %}
                                    {% if contact.home_phone %}
                                        <p>🏠 {{ contact.home_phone | format_phone }}</p>
                                    {% endif %}
                                    {% if contact.mobile_phone %}
                                        <p>📱 {{ contact.mobile_phone | format_phone }}</p>
                                    {% endif %}
                                    {% if contact.cell_phone %}
                                        <p>📱 {{ contact.cell_phone | format_phone }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            <span class="badge {% if contact.status == 'Active' %}badge-success{% else %}badge-secondary{% endif %}">
                                {{ contact.relationship_to_account or 'Primary Contact' }}
                            </span>
                        </div>
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Related Loan -->
            {% if loan %}
            <div class="bg-white border border-gray-200 rounded-lg">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Related Loan</h3>
                    <a href="{{ url_for('loans_detail', loan_id=loan.id) }}" class="text-sm text-blue-600 hover:text-blue-800">View Loan</a>
                </div>
                <div class="p-4">
                    {% set principal_balance = (loan.principal_balance | float) if loan.principal_balance else 0 %}
                    {% set past_due_fees = (loan.past_due_fees | float) if loan.past_due_fees else 0 %}
                    {% set past_due_amount = (loan.past_due_amount | float) if loan.past_due_amount else 0 %}
                    {% set total_owing = past_due_amount + past_due_fees %}
                    {% set days_delinquent = (loan.days_past_due | int) if loan.days_past_due else ((loan.days_delinquent | int) if loan.days_delinquent else 0) %}
                    {% set needs_attention = days_delinquent > 0 %}
                    
                    <a href="{{ url_for('loans_detail', loan_id=loan.id) }}" class="block border border-gray-200 rounded-lg p-4 {% if needs_attention %}border-red-200 bg-red-50{% else %}bg-gray-50{% endif %} hover:bg-gray-100 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-sm font-medium text-blue-600">
                                Contract #{{ loan.contract_number or loan.contractnumber or loan.contract_id or loan.loan_number or 'Unknown' }}
                            </h4>
                            <span class="badge {% if loan.status == 'active' %}badge-success{% elif loan.status == 'pending' %}badge-warning{% elif loan.status == 'closed' %}badge-secondary{% else %}badge-secondary{% endif %}">
                                {{ loan.status or loan.loan_status or 'Unknown' }}
                            </span>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Principal Balance:</span>
                                <span class="font-medium text-gray-900">${{ "%.2f"|format(principal_balance) }}</span>
                            </div>
                            <div class="flex justify-between w-full">
                                <div class="flex">
                                    <span class="text-gray-500">Days Delinquent:</span>
                                    <span class="font-medium {% if days_delinquent > 0 %}text-red-600{% else %}text-gray-900{% endif %} ml-2">{{ days_delinquent }} days</span>
                                </div>
                                <div class="flex">
                                    <span class="text-gray-500">Total Owing:</span>
                                    <span class="font-medium text-gray-900 ml-2">${{ "%.2f"|format(total_owing) }}</span>
                                </div>
                            </div>
                            {% if loan.financial_institution %}
                            <div class="flex justify-between">
                                <span class="text-gray-500">Financial Institution:</span>
                                <span class="font-medium text-gray-900">{{ loan.financial_institution }}</span>
                            </div>
                            {% endif %}
                        </div>
                        {% if needs_attention %}
                        <div class="mt-3 pt-3 border-t border-red-100">
                            <div class="flex items-center text-xs text-red-600">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                Attention Required
                            </div>
                        </div>
                        {% endif %}
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Related Assets -->
            {% if assets and assets|length > 0 %}
            <div class="bg-white border border-gray-200 rounded-lg">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Related Assets ({{ assets|length }})</h3>
                    <span class="text-sm text-gray-500">Manage Assets</span>
                </div>
                <div class="p-4">
                    <div class="space-y-3">
                        {% for asset in assets[:3] %}
                        {% set make_model = (asset.Make or '') ~ ' ' ~ (asset.Model or '') %}
                        {% set year = asset.Year or '' %}
                        {% set valuation = (asset.Valuation | float) if asset.Valuation else 0 %}
                        {% set insurance_status = (asset.InsuranceStatus or 'Unknown')|string|trim %}
                        
                        <a href="{{ url_for('assets_detail', asset_id=asset.id) }}" class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="font-medium text-gray-900">
                                        <span class="flex items-center">
                                            <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18 10c-.1-.1-.4-.6-.9-1.2L15.8 7c-.1-.1-.8-.7-2.2-.8L4.9 6C4.3 6 4 6.4 4 7v4c0 .6.4 1 1 1h2m0 5h10m-10 0a2 2 0 1 0 0-4m10 4a2 2 0 1 0 0-4" />
                                            </svg>
                                            {{ year }} {{ make_model.strip() or 'Unknown Vehicle' }}
                                        </span>
                                    </h4>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        {% if asset.Vin or asset.VIN %}
                                            <p>🔢 VIN: {{ asset.Vin or asset.VIN }}</p>
                                        {% endif %}
                                        {% if asset.LicensePlate %}
                                            <p>🚗 License: {{ asset.LicensePlate }}</p>
                                        {% endif %}
                                        {% if valuation %}
                                            <p>💰 Value: ${{ "%.2f"|format(valuation) }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="badge {% if insurance_status|lower == 'active' %}badge-success{% elif insurance_status|lower == 'expired' %}badge-danger{% else %}badge-secondary{% endif %}">
                                        {{ insurance_status }}
                                    </span>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                        {% if assets|length > 3 %}
                        <div class="text-center pt-2 border-t">
                            <span class="text-sm text-blue-600">
                                {{ assets|length - 3 }} more assets...
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="bg-white border border-gray-200 rounded-lg">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Related Assets (0)</h3>
                    <span class="text-sm text-gray-500">Manage Assets</span>
                </div>
                <div class="p-4">
                    <div class="text-center text-gray-500 py-8">
                        <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18 10c-.1-.1-.4-.6-.9-1.2L15.8 7c-.1-.1-.8-.7-2.2-.8L4.9 6C4.3 6 4 6.4 4 7v4c0 .6.4 1 1 1h2m0 5h10m-10 0a2 2 0 1 0 0-4m10 4a2 2 0 1 0 0-4" />
                        </svg>
                        <p class="mt-2">No assets found</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/cases.js') }}"></script>
{% endblock %}